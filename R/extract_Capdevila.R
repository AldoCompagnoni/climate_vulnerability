# extract Capdevila's values
library( raster )
library( tidyverse )

# Pol Capdevila's Lat/Lon
load( 'data/ResilienceLatLong.RData' )

# layers
t_cor <- raster( 'results/tmean_cor.tif' )
p_cor <- raster( 'results/prec_cor.tif' )

tmps  <- raster( 'data/chelsa_tmps.tif' )
ppts  <- raster( 'data/chelsa_ps.tif' )

iso   <- raster( 'data/chelsa_iso.tif' )
mdr   <- raster( 'data/chelsa_mdr.tif' )
tmpar <- raster( 'data/chelsa_tmpar.tif' )



# Capddevila's values ------------------------------------------

# coordinates
site_coord <- compadreLatLon %>% 
                dplyr::select(Lon, Lat) %>% 
                rename( Latitude  = Lat,
                        Longitude = Lon ) %>% 
                dplyr::select( Longitude, Latitude ) %>% 
                as.matrix  

# extract values from raster layers
temp_vals <- raster::extract( t_cor, site_coord, method = 'bilinear')
prec_vals <- raster::extract( p_cor, site_coord, method = 'bilinear')

# extract values from raster layers
tems_vals <- raster::extract( tmps,  site_coord, method = 'bilinear')
ppts_vals <- raster::extract( ppts,  site_coord, method = 'bilinear')

iso_vals  <- raster::extract( iso,   site_coord, method = 'bilinear')
mdr_vals  <- raster::extract( mdr,   site_coord, method = 'bilinear')
tmpar_vals<- raster::extract( tmpar, site_coord, method = 'bilinear')


# store autocorrelation values for Pol
compadreLatLon %>% 
  mutate( tmean_autoc = temp_vals,
          prec_autoc  = prec_vals,
          tmp_season  = tems_vals,
          ppt_season  = ppts_vals,
          isotherm    = iso_vals,
          diurn_range = mdr_vals,
          tmp_ann_rng = tmpar_vals ) %>% 
  write.csv( 'results/compadre_climate_6.2.2020.csv',
             row.names=F)




# Plant review's values ------------------------------------------
  

# plant review data frame
pr_df    <- read.csv( 'C:/CODE/plant_review_analyses/results/synthesis_added/all_6yr.csv' ) %>% 
             dplyr::select( SpeciesAuthor, MatrixPopulation, Lat, Lon ) %>% 
             unique
           
# coords for extraction
pr_coord <- pr_df %>% 
              dplyr::select(Lon, Lat) %>% 
              rename( Latitude  = Lat,
                      Longitude = Lon ) %>% 
              dplyr::select( Longitude, Latitude ) %>% 
              as.matrix  
  
# extract values from raster layers
temp_vals <- raster::extract( t_cor, pr_coord, method = 'bilinear')
prec_vals <- raster::extract( p_cor, pr_coord, method = 'bilinear')

# store it
pr_df %>% 
  mutate( tmean_autoc = temp_vals,
          prec_autoc  = prec_vals ) %>% 
  write.csv( 'C:/CODE/plant_review_analyses/results/synthesis_added/all_6yr_autocorr.csv',
             row.names=F )


  
  
# plot world map of ------------------------------
tm <- raster( 'results/tmean_sd.tif' )
ext <- c(-160, -50, 15, 70)

tm_na <- crop( tm, ext )

png( 'results/mean/na_tmean_sd.png',
     width = 6.3, height = 6.3,
     unit = 'in', res = 600 )
plot( tm_na )
dev.off()
