# Script with request for help to Simon 
library(tidyverse)
library(leaflet)
library(raster)


# The two links to download 

# link for temperature file
# note: these are monthly "timeseries" data. I get these from chelsa-climate.org
tmean_link  <- "https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/timeseries/tmean/CHELSA_tmean_2000_01_V1.2.1.tif"
prec_link   <- "https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/timeseries/prec/CHELSA_prec_2000_01_V1.2.1.tif"


# Download and load two raster layers 

download.file( tmean_link, destfile = 'tmean_2000_jan.tif', mode = "wb")
download.file( prec_link,  destfile = 'prec_2000_jan.tif', mode = "wb")

# read both layers and plot them

tmean_l    <- raster( 'tmean_2000_jan.tif' )
prec_l     <- raster( 'prec_2000_jan.tif' )

# PROBLEM: how can I "crop" the amount of data that is not on the 

# temperature information is all over the earth
plot(tmean_l)

# precipitation information on the seas if above 40000. 
# Measures above 40000 are actually NAs: there is not data there
plot(prec_l)


# check that this is correct:
# extract coordinates over the Atlantic sea, 
# and close to leipzig
coord_df <- data.frame( Long = c(-20,12),
                         Lat  = c(45, 51) )

# chek
leaflet(coord_df) %>% 
  addTiles()  %>% 
  addCircleMarkers(~Long,~Lat)


# Extract values
coord_mat <- coord_df %>% as.matrix

# over the sea, precipitation data is "65535" 
raster::extract(prec_l,  coord_mat) 

# over the sea, we have meaningful temperature data (e.g. Temp is higher on the ocean).
# NOTE: this chelsa data is in Kelvin degrees * 10. 
(raster::extract(tmean_l, coord_mat) / 10) - 273.15


# QUESTION: can we use the Sea data, or any data, to 
# just plot data over terrestrial habitats, excluding the oceans?
  