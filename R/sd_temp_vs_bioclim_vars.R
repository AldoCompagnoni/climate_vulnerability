library(raster)
library(tidyverse)
library(rworldmap)

# load data ---------------------------------------------------------------------

# europe extent
ext_e     <- extent( -10, 50, 30, 65 )  

# annual standard deviation in temperature 
sPDF       <- getMap()
tm_sd      <- raster('results/tmean_sd.tif') %>% crop( ext_e )
tm_sd_c    <- tm_sd / 10

# other bioclimatic variables 

# isothermality
iso        <- raster( 'data/isotherm.tif' ) %>% crop( ext_e )
sea        <- raster( 'data/seasonality.tif' ) %>% crop( ext_e )
mdr        <- raster( 'data/mdr.tif' ) %>% crop( ext_e )

# all together
tm_stack   <- stack( tm_sd_c, iso, sea, mdr )   

# function to calculate the correlation
rast_corr  <- function(x) cor(x[1], x[2], method='spearman')

# get sd for cropped area
out_c      <- calc( tm_stack, fun = rast_corr )


# sample grid (to decrease number of points extracted)
site_coord <- expand.grid( 
  Longitude = seq(-10, 40, length.out = 100),
  Latitude  = seq( 30, 60, length.out = 100)  
  )

# extract values
values_clim <- raster::extract(tm_stack, site_coord, method = 'bilinear')

# correlation
clim_df     <- values_clim %>% 
                as.data.frame %>% 
                drop_na 

# pairs
clim_df %>% pairs

ggplot( clim_df ) +
  geom_point( aes(tmean_sd, seasonality),
              alpha = 0.1 ) +
  theme_minimal() +
  labs( x = 'Standard deviation of annual temperature',
        y = 'Temperature seasonality' ) +
  ggsave( 'results/mean/temp_sd_vs_.tiff',
          width = 3.15, height = 3.15,
          compression = 'lzw' )
  


# do analyses for europe only

tm_sd_e <- crop( tm_sd_c, ext_e)
tm_sd_e <- crop( tm_sd_c, ext_e)
