library(raster)
library(tidyverse)
library(rworldmap)


# annual standard deviation in temperature --------------------------------------
sPDF       <- getMap()
tm_sd      <- raster('results/tmean_sd.tif')
tm_sd_c    <- tm_sd / 10

# climatology -------------------------------------
tm_link     <- 'https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/bioclim/integer/CHELSA_bio10_01.tif'

# links
download.file( tm_link, destfile = 'mat.tif', mode = "wb")

# read raster file
mat        <- raster::raster( 'mat.tif' )





# Mean monthly max./min. temperature -----------------------------------------------------------------------------

# different future projections. Links .nc_1_2041 refer to annual TEMPERATURE

# leftie
left   <- 'https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/cmip5/2041-2060/bio/CHELSA_bio_mon_NorESM1-M_rcp45_r1i1p1_g025.nc_1_2041-2060_V1.2.tif'

# second to left 
left2  <- 'https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/cmip5/2041-2060/bio/CHELSA_bio_mon_MPI-ESM-LR_rcp45_r1i1p1_g025.nc_1_2041-2060_V1.2.tif'

# center
cntr   <- 'https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/cmip5/2041-2060/bio/CHELSA_bio_mon_GISS-E2-R_rcp45_r1i1p1_g025.nc_1_2041-2060_V1.2.tif'

# second to right
right2 <- 'https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/cmip5/2041-2060/bio/CHELSA_bio_mon_CMCC-CM_rcp45_r1i1p1_g025.nc_1_2041-2060_V1.2.tif'

# right
right  <- 'https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/cmip5/2041-2060/bio/CHELSA_bio_mon_CESM1-BGC_rcp45_r1i1p1_g025.nc_1_2041-2060_V1.2.tif'


# download file

# links
link_v    <- c( left, left2, cntr, right2, right )
dest_v    <- paste0( 'proj_', 1:5, '.tif')
ii        <- 5
download.file( link_v[ii], destfile = dest_v[ii], mode = "wb" )

# read raster file
proj_r    <- raster( dest_v[ii] )


# Temperature SD for Europe -------------------------------------



# Delta T for Europe/NA -------------------------------------
ext_e     <- c( -10, 50, 30, 65 ) 
# ext_na    <- extent( -140, -60, 10, 80 )  

tm_sd_e   <- crop( tm_sd,  ext_e ) / 10
# tm_sd_na  <- crop( tm_sd,  ext_na ) / 10
proj_e    <- crop( proj_r, ext_e )
# proj_na   <- crop( proj_r, ext_na )
mat_e     <- crop( mat,    ext_e )
# mat_na    <- crop( mat,    ext_na )

# difference in temperature projected
dt_pr_e   <- (proj_e  - mat_e) / 10
# dt_pr_na  <- (proj_na - mat_na) / 10

# difference in 
dt_sd_e   <- dt_pr_e  / tm_sd_e
# dt_sd_na  <- dt_pr_na / tm_sd_na

# plots
tiff( paste0('results/delta_temp/delta_sd_t_europe_',ii,'.tiff'),
      width = 6.3, height = 6.3, 
      unit = 'in', res = 600, compression = 'lzw')
plot(dt_sd_e, col=rainbow(100), legend=FALSE, axes=FALSE)
plot( sPDF, add = T )
plot(dt_sd_e, col=rainbow(100),
     legend.only=TRUE, 
     legend.width=1, legend.shrink=0.75,
     legend.cex=2,
     axis.args=list(at       = seq(1, 3, 0.5),
                    labels   = seq(1, 3, 0.5),
                    cex.axis = 2) )
dev.off()


tiff( 'results/delta_temp/delta_sd_t_usa.tiff',
      width = 6.3, height = 6.3, 
      unit = 'in', res = 600, compression = 'lzw')
plot( dt_sd_na )
dev.off()


# GLOBAL ----------------------------------------------

tm_sd_c   <- tm_sd / 10
proj_c    <- proj_r / 10
mat_c     <- mat / 10

# difference in temperature projected
dt_pr_c   <- (proj_c  - mat_c) 

# difference in 
dt_sd_c   <- dt_pr_c  / tm_sd_c

title( expression(Delta) )

tiff( 'results/delta_temp/delta_sd_t.tiff',
      width = 6.3, height = 6.3, unit = 'in', res = 600,
      compression='lzw')
plot( dt_sd_c )
dev.off()
