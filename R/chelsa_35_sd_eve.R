library(raster)
library(tidyverse)

# arguments from command line
args     <- commandArgs(trailingOnly = TRUE)

# set up job variables
job_n    <- as.numeric(args[1])
code_dir <- args[2]
rasr_fil <- args[3]
out_file <- args[4]

print( args )


# set up the grid to get extents to crop rasters
lat_seq <- seq(-90,83.99986,by=5)
lon_seq <- seq(-180,179.9999,by=10)
lat_x   <- paste0( lat_seq[1:(length(lat_seq)-1)], '_',
                   lat_seq[2:length(lat_seq)] )
lon_x   <- paste0( lon_seq[1:(length(lon_seq)-1)], '_',
                   lon_seq[2:length(lon_seq)] )

# crop coordinates
crop_cr <- expand.grid( lat = lat_x,
                        lon = lon_x,
                        var = c('tmean','prec'),
                        stringsAsFactors = F ) %>% 
             separate( lat, c('lat1', 'lat2'), sep='_' ) %>% 
             separate( lon, c('lon1', 'lon2'), sep='_' ) %>% 
             mutate_at( c('lat1', 'lat2',
                          'lon1', 'lon2'),
                        as.numeric ) %>% 
             mutate( id = 1:nrow(.) ) %>% 
             subset( id == job_n )

print( 'read layers' )

# read and stack the 35 years of data
rast_l   <- list.files( rasr_fil ) %>% 
              grep( '.tif', ., value=T ) %>% 
              grep( crop_cr$var,. , value=T )
rast_l

all_mon  <- stack( paste0(rasr_fil, rast_l) )


# define area to crop and do operations of
ext     <- extent( crop_cr$lon1, 
                   crop_cr$lon2,
                   crop_cr$lat1, 
                   crop_cr$lat2 )  

print( 'crop raster' )

# "cropped" raster
all_cr  <- crop( all_mon , ext )

print( 'take sd' )

# get sd for cropped area
out_sd  <- stackApply( all_cr, rep(1,35), fun = sd )
  
print( 'write out' )

# store yearly data
writeRaster( out_sd, paste0(out_file, 
                            crop_cr$var,'_sd_',
                            job_n, '.tif')  )

