library(raster)
library(tidyverse)
library(rworldmap)

dir        <- 'C:/Users/ac22qawo/clim_vulnerability/crop/'
rast_l     <- list.files( dir ) %>% grep( 'tmean_',.,value=T)
rast_ord   <- rast_l %>% 
  gsub('tmean_sd_|.tif','',.) %>% 
  as.numeric %>% 
  order
rast_l     <- rast_l[rast_ord]

# read raster tiles
read_rast  <- function(ii){
  raster( paste0(dir, rast_l[ii]) )
}

# put the tiles together ------------------------------------------------------------

# do 100 tiles at a time
crou_r     <- lapply( 1:100, read_rast )
out_1      <- do.call( merge, crou_r)

crou_r     <- lapply( 101:200, read_rast )
out_2      <- do.call( merge, crou_r)

crou_r     <- lapply( 201:300, read_rast )
out_3      <- do.call( merge, crou_r)

crou_r     <- lapply( 301:400, read_rast )
out_4      <- do.call( merge, crou_r)

crou_r     <- lapply( 401:500, read_rast )
out_5      <- do.call( merge, crou_r)

crou_r     <- lapply( 501:600, read_rast )
out_6      <- do.call( merge, crou_r)

crou_r     <- lapply( 601:700, read_rast )
out_7      <- do.call( merge, crou_r)

crou_r     <- lapply( 701:800, read_rast )
out_8      <- do.call( merge, crou_r)

crou_r     <- lapply( 801:900, read_rast )
out_9      <- do.call( merge, crou_r)

crou_r     <- lapply( 1001:1100, read_rast )
out_11     <- do.call( merge, crou_r)


out        <- list( out_1,  out_2, out_3,  out_4,
                    out_5,  out_6, out_7,  out_8,
                    out_9,  out_11 ) %>% 
                  do.call( merge, . )

# store yearly data
writeRaster( out, 'results/tmean_sd_almost.tif')

out <- raster( 'results/tmean_sd_almost.tif' )

# do 100 tiles at a time -----------------------------


out_911     <- lapply( 911, read_rast )
out_912     <- lapply( 912, read_rast )
out_911_912 <- do.call( merge, list(out_911, out_912) )

out_921     <- lapply( 921, read_rast )
out_922     <- lapply( 922, read_rast )


prova       <- do.call( merge, list(out_911[[1]], out_912[[1]], 
                                    out_921[[1]], out_922[[1]] ) )


crou_r     <- lapply( 913:915, read_rast )
out_913_915<- do.call( merge, crou_r )

crou_r     <- lapply( 916:920, read_rast )
out_920    <- do.call( merge, crou_r)

crou_r     <- lapply( 923:925, read_rast )
out_923_925<- do.call( merge, crou_r )

crou_r     <- lapply( 926:930, read_rast )
out_930    <- do.call( merge, crou_r)

crou_r     <- lapply( 931:1000, read_rast )
out_1000   <- do.call( merge, crou_r)

crou_r     <- lapply( 1001:1106, read_rast )
out_1106   <- do.call( merge, crou_r)

out_911_r  <- list( out_1,  out_2, out_3,  out_4,
                    out_5,  out_6, out_7,  out_8,
                    out_9,  out_11,
                    # prova,
                    out_920, out_913_915,
                    out_930, out_1000, out_1106 ) 
out_911    <- do.call( merge, out_911_r )

# store yearly data
writeRaster( out_911, 'results/tmean_sd.tif', overwrite=TRUE )



# debug -----------------------------------------------

# get coarse resolution world from rworldmap
sPDF       <- getMap()
tm_sd      <- raster('results/tmean_sd.tif')
tm_sd_c    <- tm_sd / 10

x11()
plot( tm_sd_c )
plot( sPDF, add = TRUE )
