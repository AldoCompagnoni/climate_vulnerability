# File to be sent to Simon 
# 1. Set up variables to download chelsa data directly
# 2. Download and load two raster layers
# 3. Sum those two layers up
library(tidyverse)
library(raster)


# 1. Set up variables to download chelsa data directly --------------------------

# this is our job ID!
job_n     <- 1

# decide what year by variable we'll be downloading
job_df    <- expand.grid( variable = c('tmean','prec'),
                          year     = c(1979:2013),
                          stringsAsFactors = F) %>% 
              mutate( id = c(1:nrow(.)) ) %>% 
              subset( id == job_n )
                          
# ALL data from chelsa from 1979 to 2013
chelsa_df <- expand.grid( variable = c('tmean','prec'),
                          year     = c(1979:2013),
                          month    = c(paste0('0',1:9),
                                       10,11,12),
                          stringsAsFactors = F) %>%
                arrange(variable, year, month) %>% 
                # limit the scope of our job!
                subset( variable == job_df$variable &
                        year     == job_df$year )
                
# set up reading
read_dir  <- 'https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/timeseries/'

# produce file name based on index 'ii'
produce_file_name <- function(ii){
  
  paste0(chelsa_df$variable[ii],
         '/CHELSA_',
         chelsa_df$variable[ii],'_',
         chelsa_df$year[ii],'_',
         chelsa_df$month[ii],'_',
         'V1.2.1.tif')
  
}

# get all file links (from file name)
file_names <- sapply(1:nrow(chelsa_df), produce_file_name) 
file_links <- paste0(read_dir, file_names)
file_dest  <- paste0( getwd(), gsub("tmean|prec","",file_names) )


# lat/lon subdivisions -----------------------------------

# set up the grid to get extents to crop rasters
lat_seq <- seq(-90,83.99986,by=5)
lon_seq <- seq(-180,179.9999,by=10)
lat_x   <- paste0( lat_seq[1:(length(lat_seq)-1)], '_',
                   lat_seq[2:length(lat_seq)] )
lon_x   <- paste0( lon_seq[1:(length(lon_seq)-1)], '_',
                   lon_seq[2:length(lon_seq)] )

# crop coordinates
crop_cr <- expand.grid( lat = lat_x,
                        lon = lon_x,
                        var = c('tmean','prec'),
                        stringsAsFactors = F ) %>% 
  separate( lat, c('lat1', 'lat2'), sep='_' ) %>% 
  separate( lon, c('lon1', 'lon2'), sep='_' ) %>% 
  mutate_at( c('lat1', 'lat2',
               'lon1', 'lon2'),
             as.numeric ) %>% 
  mutate( id = 1:nrow(.) ) %>% 
  subset( id == 1 )



# 2. Download and load two raster layers ---------------------------------------------------------


# function to download raster files
download_layers <- function(ii){
  
  download.file( file_links[ii], destfile = file_dest[ii], mode = "wb")
  
}
  
# simply download the raster files!
lapply(1:12, download_layers)

# load raster
rast_l   <- list.files() %>% grep('.tif',.,value=T)
all_mon  <- stack(rast_l[1:5])

# take sum/mean!

x = rnorm(100)
y = rnorm(100)

extr_corr <- function(x, y){
  pacf(x, lag.max=1,
       plot=F) %>% .$acf %>% .[1]
}
 
# let's say we have two Raster objects with three layers
x <- all_mon[[1:3]]
y <- s[[4:6]]

# stack these
z <- stack(x,y)
 
extr_corr(all_mon)



year_prova <- extr_corr(all_mon)

# if temperature data, take mean!
if( job_df$variable == 'tmean'){
  year_r     <- mean(all_mon)
  
}

# if precipitation data, take sum!
if( job_df$variable == 'prec'){
  
  year_r <- sum( all_mon )
  
}

# store yearly data
writeRaster( year_r, 'raster_name.tif')



# coord
coord_df <- read.csv('C:/Users/ac22qawo/animal_review/all_coord.csv',
                     stringsAsFactors = F) %>% 
  dplyr::select( Latitude, Longitude ) %>% 
  mutate( Longitude = as.numeric(Longitude),
          Latitude  = as.numeric(Latitude) )

# site coord MATRIX (to feed "raster")
site_coord <-  matrix(c(coord_df$Longitude,
                        coord_df$Latitude),
                      dimnames = list(rep('value',nrow(coord_df)),
                                      c('Long', 'Lat')),
                      byrow = FALSE, nrow = nrow(coord_df) )

