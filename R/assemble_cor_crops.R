library(raster)
library(tidyverse)
library(rworldmap)

# get coarse resolution world from rworldmap
sPDF <- getMap()

# read the rasters
read_rast  <- function(ii){
  raster( paste0('results/',rast_l[ii]) )
}

# read theree big tiles
rast_l     <- list.files( 'results' )
all_r      <- lapply( 1:3, read_rast )
all_out    <- do.call( merge, all_r)



# store yearly data
writeRaster( all_out, 'results/tmean_sd.tif')


plot(all_out, xlim=c(-5, 30), ylim=c(30,50) )


# Temperature -----------------------------------------------------------
dir        <- 'C:/Users/ac22qawo/clim_vulnerability/crop_cor/'
rast_l     <- list.files( dir ) %>% grep( 'tmean_',.,value=T)
rast_ord   <- rast_l %>% 
                gsub('tmean_cor_|.tif','',.) %>% 
                as.numeric %>% 
                order
rast_l     <- rast_l[rast_ord]


read_rast  <- function(ii){
  raster( paste0(dir, rast_l[ii]) )
}


list(all_out, read_rast(911),
     read_rast(912) ) %>% do.call( merge, . )

all_out    <- do.call( merge, all_r)


# do 100 tiles at a time
crou_r     <- lapply( 1:100, read_rast )
out_1      <- do.call( merge, crou_r)

crou_r     <- lapply( 101:200, read_rast )
out_2      <- do.call( merge, crou_r)

crou_r     <- lapply( 201:300, read_rast )
out_3      <- do.call( merge, crou_r)

crou_r     <- lapply( 301:400, read_rast )
out_4      <- do.call( merge, crou_r)

crou_r     <- lapply( 401:500, read_rast )
out_5      <- do.call( merge, crou_r)

crou_r     <- lapply( 501:600, read_rast )
out_6      <- do.call( merge, crou_r)

crou_r     <- lapply( 601:700, read_rast )
out_7      <- do.call( merge, crou_r)

crou_r     <- lapply( 701:800, read_rast )
out_8      <- do.call( merge, crou_r)

crou_r     <- lapply( 801:900, read_rast )
out_9      <- do.call( merge, crou_r)

crou_r     <- lapply( 901:1000, read_rast )
out_10     <- do.call( merge, crou_r)

crou_r     <- lapply( 1001:1190, read_rast )
out_11     <- do.call( merge, crou_r)


# all together
out_cor    <- list( out_1, out_2, 
                    out_3, out_4,
                    out_5, out_6,
                    out_7, out_8,
                    out_9, out_10,
                    out_11 ) %>% 
                do.call( merge, . )
  
# store yearly data
writeRaster( out_cor, 'results/tmean_cor.tif')

tiff( 'results/tmean_cor.tiff',
      width=6.3, height = 6.3, unit='in',
      res=600, compression='lzw' )
plot( out_cor )
plot(sPDF, add = TRUE)
dev.off()



# PRECIPITATION -----------------------------------------------------
dir        <- 'C:/Users/ac22qawo/clim_vulnerability/crop_cor/'
rast_l     <- list.files( dir ) %>% grep( 'prec_',.,value=T)
rast_ord   <- rast_l %>% 
                gsub('prec_cor_|.tif','',.) %>% 
                as.numeric %>% 
                order
rast_l     <- rast_l[rast_ord]


# do 100 tiles at a time
crou_r     <- lapply( 1:100, read_rast )
out_1      <- do.call( merge, crou_r)

crou_r     <- lapply( 101:200, read_rast )
out_2      <- do.call( merge, crou_r)

crou_r     <- lapply( 201:300, read_rast )
out_3      <- do.call( merge, crou_r)

crou_r     <- lapply( 301:400, read_rast )
out_4      <- do.call( merge, crou_r)

crou_r     <- lapply( 401:500, read_rast )
out_5      <- do.call( merge, crou_r)

crou_r     <- lapply( 501:600, read_rast )
out_6      <- do.call( merge, crou_r)

crou_r     <- lapply( 601:700, read_rast )
out_7      <- do.call( merge, crou_r)

crou_r     <- lapply( 701:800, read_rast )
out_8      <- do.call( merge, crou_r)

crou_r     <- lapply( 801:900, read_rast )
out_9      <- do.call( merge, crou_r)

crou_r     <- lapply( 901:1000, read_rast )
out_10     <- do.call( merge, crou_r)

crou_r     <- lapply( 1001:1190, read_rast )
out_11     <- do.call( merge, crou_r)


# all together
out_prec   <- list( out_1, out_2, 
                    out_3, out_4,
                    out_5, out_6,
                    out_7, out_8,
                    out_9, out_10,
                    out_11 ) %>% 
                do.call( merge, . )

# store global raster
writeRaster( out_prec, 'results/prec_cor.tif')

tiff( 'results/prec_cor.tiff',
      width=6.3, height=6.3, unit='in',
      res=600, compression='lzw' )
plot( out_prec )
plot(sPDF, add = TRUE)
dev.off()
