
library(tidyverse)
library(raster)

# arguments from command line
args     <- commandArgs(trailingOnly = TRUE)


# set up job variables
job_n    <- as.numeric(args[1])
code_dir <- args[2]
data_dir <- args[3]
out_file <- args[4]

print(args)

# 1. Set up variables to download chelsa data directly --------------------------

# decide what year by variable we'll be downloading
job_df    <- expand.grid( variable = c('tmean','prec'),
                          year     = c(1979:2013),
                          stringsAsFactors = F) %>% 
              mutate( id = c(1:nrow(.)) ) %>% 
              subset( id == job_n )
                          
# ALL data from chelsa from 1979 to 2013
chelsa_df <- expand.grid( variable = c('tmean','prec'),
                          year     = c(1979:2013),
                          month    = c(paste0('0',1:9),
                                       10,11,12),
                          stringsAsFactors = F) %>%
                arrange(variable, year, month) %>% 
                # limit the scope of our job!
                subset( variable == job_df$variable &
                        year     == job_df$year )
                
# set up reading
read_dir  <- 'https://envidatrepo.wsl.ch/uploads/chelsa/chelsa_V1/timeseries/'

# produce file name based on index 'ii'
produce_file_name <- function(ii){
  
  paste0(chelsa_df$variable[ii],
         '/CHELSA_',
         chelsa_df$variable[ii],'_',
         chelsa_df$year[ii],'_',
         chelsa_df$month[ii],'_',
         'V1.2.1.tif')
  
}

# get all file links (from file name)
file_names <- sapply(1:nrow(chelsa_df), produce_file_name) 
file_links <- paste0(read_dir, file_names)
file_dest  <- paste0( data_dir, gsub("tmean/|prec/","",file_names) )


# 2. Download data and average it/sum --------------------------------------


# function to download raster files
download_layers <- function(ii){
  
  download.file( file_links[ii], destfile = file_dest[ii], mode = "wb")
  
}
  
# simply download the raster files!
lapply(1:12, download_layers)

# load raster
rast_l   <- file_dest
all_mon  <- stack(rast_l)


# take sums/means!

# if temperature data, take mean!
if( job_df$variable == 'tmean'){
  year_r <- stackApply(all_mon, rep(1,12), fun = mean)
}

# if precipitation data, take sum!
if( job_df$variable == 'prec'){
  year_r <- stackApply(all_mon, rep(1,12), fun = sum)
}

# store yearly data
writeRaster( year_r, paste0(out_file, 
                            job_df$variable,'_',
                            job_df$year,'.tif')  )

# remove files 
file.remove( file_dest )
