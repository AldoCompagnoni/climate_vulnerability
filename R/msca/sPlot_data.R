library(tidyverse)
library(leaflet)
library(BIEN)
library(maps)
library(popler)
options(stringsAsFactors = F)

data_dir       <- 'C:/Users/ac22qawo/Dropbox/GRANT/2020/MarieCurie/data/'

# sPlot species
sPlot_spp      <- read.csv( paste0(data_dir, 'sPlot3_speciesList_Aldo.csv') ) %>% 
                    setNames( c('Genus','species') ) %>% 
                    subset( !(species %in% '') ) 

# Species list
spp_list <- sPlot_spp %>% 
              mutate( spp = paste( Genus, 
                                   species, 
                                   sep = ' ' ) ) %>% 
              .$spp


# Check overlap with BIEN ----------------------------------------------------

# data containers for species distribution andc species range data
sd_data <- list()
sr_data <- list()

# Download species distribution data
for(ii in 1:length(spp_list) ){
  
  sd_data[[ii]] <- BIEN_occurrence_species(species = spp_list[ii] )
  print( paste0(ii, ' ', spp_list[ii]) )
  
}

# Put it all in a data frame
sd_df <- bind_rows( sd_data ) 

# Number of species with at least 21 occurrence points 
sd_df %>% 
  count( scrubbed_species_binomial ) %>% 
  subset( n > 25 ) %>% 
  dim

# Median occurrence data: 643 values!!!
sd_df %>% 
  count( scrubbed_species_binomial ) %>% 
  subset( n > 25 ) %>% 
  .$n %>% 
  median
  

# store this data (as it's )
write.csv(sd_df, 'data/bien/sPlot_bien_occ_1_500.csv', row.names=F)


# modularized download --------------------------------------

# for supercomputer
design_df <- data.frame( second = c(500*c(1:140)) ) %>% 
               mutate( id = c(1:length(second)),  
                       first = c(1, second[-140]+1) ) %>% 
               select( id, first, second )


# reduced download: "only" 20 slices evenly spaced across species
id_v      <- 7*c(1:20)


# c( :69218 ) %>% length
# tmp_ii$first <- (69218-499)
# tmp_ii$second <- 69218
  
# double if to download AND de-bug if needed.
for( kk in 1:length(id_v) ){

  tmp_ii  <- subset( design_df, id == id_v[kk] )
  
  # set up data list
  sd_data <- list()
  
  # Download species distribution data
  for(ii in tmp_ii$first:tmp_ii$second ){
    
    sd_data[[ii]] <- BIEN_occurrence_species( species = spp_list[ii] )
    print( paste0(ii, ' ', spp_list[ii]) )
    
  }

  sd_df <- bind_rows( sd_data ) 
  
  out_f <- paste0( 'data/bien/sPlot_bien_occ_',
                   tmp_ii$first, '_',
                   tmp_ii$second,
                   '.csv' )
  
  # store this data (as it's )
  write.csv(sd_df, out_f, row.names=F)
  
}

# re-read files
list_f <- list.files( 'data/bien/' ) %>% 
            grep('sPlot',.,value=T) %>% 
            paste0('data/bien/',.)


file_l <- lapply( list_f, read.csv )
all_df <- bind_rows( file_l )

# Number of species with at least 21 occurrence points 
spp_n  <-  all_df$scrubbed_species_binomial %>% n_distinct

# Number of species with at least 25 occurrence points 
spp_ok <- all_df %>% 
            count( scrubbed_species_binomial ) %>% 
            subset( n > 24 ) %>% 
            nrow

# % of 
spp_ok / spp_n

# Median occurrence data: 643 values!!!
occ_m <- all_df %>% 
          count( scrubbed_species_binomial ) %>% 
          subset( n > 25 ) %>% 
          .$n %>% 
          median
