library(tidyverse)
library(leaflet)
library(BIEN)
library(maps)
library(popler)
options(stringsAsFactors = F)

data_dir       <- 'C:/Users/ac22qawo/Dropbox/GRANT/2020/MarieCurie/data/'

# popdat data
popdat_all    <- read.csv( paste0(data_dir, 'popdat.csv') ) #Query02_04_2018?
popdat_plants <- read.csv( paste0(data_dir, 'plant_popdat_rawdata.csv') )

# only refer to plants
bt_plants      <- popdat_plants %>% 
                    select( GENUS_SPECIES ) %>% 
                    unique %>% 
                    left_join( popdat_all ) %>% 
                    mutate( PLOT = replace(PLOT, is.na(PLOT), 'NA') )


# number of consecutive years
n_consec_yrs <- function(x){
    
  # raw, lag, construct consecutive years
  y_raw <- x %>% unique %>% sort
  y_lag <- lag(y_raw)
  ( (y_raw-y_lag) == 1 ) %>% which %>% length
  
}

# alternative (more sensible?) method
bt_yrs        <- bt_plants %>%
                    select( -GENUS, -SPECIES ) %>% 
                    group_by( STUDY_ID, GENUS_SPECIES, PLOT, 
                              LATITUDE, LONGITUDE ) %>% 
                    summarise( n        = n_distinct(YEAR),
                               n_consec = n_consec_yrs(YEAR) ) %>% 
                    ungroup
 
# How many species with at least 10 lambda values
bt_yrs %>% 
  subset( n_consec > 10 ) %>% 
  subset( !grepl('Unknown| sp',GENUS_SPECIES) ) %>% 
  .$GENUS_SPECIES %>% 
  unique %>% sort %>% 
  n_distinct

# Visual checks
bt_yrs %>% 
  subset( n_consec > 10 ) %>% 
  select( LATITUDE, LONGITUDE ) %>% 
  unique %>% 
  leaflet %>% 
  addTiles() %>% 
  addCircleMarkers(~LONGITUDE, ~LATITUDE, radius = 1)


# Species list
spp_list <- bt_yrs %>% 
  subset( n_consec > 10 ) %>% 
  subset( !grepl('Unknown| sp',GENUS_SPECIES) ) %>% 
  .$GENUS_SPECIES %>% 
  unique %>% 
  sort


# Check overlap with BIEN ----------------------------------------------------

# data containers for species distribution andc species range data
sd_data <- list()
sr_data <- list()

# Download species distribution data
for(ii in 1:length(spp_list) ){
  
  sd_data[[ii]] <- BIEN_occurrence_species(species = spp_list[ii] )
  print( paste0(ii, ' ', spp_list[ii]) )
  
}

# Put it all in a data frame
sd_df <- bind_rows( sd_data ) 

# Number of species with at least 21 occurrence points 
sd_df %>% 
  count( scrubbed_species_binomial ) %>% 
  subset( n > 20 ) %>% 
  dim

# Median occurrence data: 643 values!!!
sd_df %>% 
  count( scrubbed_species_binomial ) %>% 
  .$n %>% median
  

# store this data (as is )
write.csv(sd_df, 'data/bien/popdat_bien_occ.csv', row.names=F)


# debug "problem studies in "bt_reps" ----------------------------------------

# Count number of years
bt_reps        <- bt_plants %>%
                    select( -GENUS, -SPECIES ) %>% 
                    count( STUDY_ID, GENUS_SPECIES, PLOT, 
                           LATITUDE, LONGITUDE ) %>% 
                    subset( n > 9 )

# Problem studies
prob_st       <- bt_reps %>%
                  subset( n > 30 ) %>% 
                  .$STUDY_ID %>% 
                  unique

# Problem studies
keep_st       <- bt_reps %>%
                  subset( n < 31 ) %>% 
                  .$STUDY_ID %>% 
                  unique

# Long enough studies
spp_long      <- bt_reps %>% 
                  subset( STUDY_ID %in% keep_st ) %>% 
                  .$GENUS_SPECIES %>% 
                  unique

# Plot locations
bt_plants %>% 
  subset( GENUS_SPECIES %in% spp_long ) %>% 
  select( LATITUDE, LONGITUDE ) %>% 
  unique %>% 
  leaflet %>% 
  addTiles() %>% 
  addCircleMarkers(~LONGITUDE, ~LATITUDE)


# puzzling data structure --------------------------------------------------

prob_st

# Example 1
popdat_all %>% 
  subset( STUDY_ID == 214 & GENUS_SPECIES == 'Picea sitchensis') %>% 
  select( LATITUDE, LONGITUDE ) %>% 
  unique %>% 
  leaflet %>% 
  addTiles() %>% 
  addCircleMarkers(~LONGITUDE, ~LATITUDE)


# LOTS of replicates
popdat_all %>% 
  subset( STUDY_ID == 214 & GENUS_SPECIES == 'Picea sitchensis') %>% 
  subset(LATITUDE == 47.78500 & LONGITUDE == -123.9182 ) %>% 
  subset( grepl('HSGY_HR01_3',SAMPLE_DESC) )
  

popdat_plants %>% 
  subset( STUDY_ID == 214 & GENUS_SPECIES == 'Picea sitchensis' ) %>% 
  # subset( LATITUDE == 47.785 & LONGITUDE == -123.9182 )
  subset( grepl('HSGY_HR01_3',SAMPLE_DESC) )


# Good study --------------------
bt_reps %>% 
  subset( GENUS_SPECIES == 'Lesquerella ovalifolia' )

popdat_all %>%
  # popdat_plants %>% 
  subset( STUDY_ID == 298 & GENUS_SPECIES == 'Lesquerella ovalifolia') %>%
  separate( PLOT, c('PLOT', 'gibberish'), '-' ) %>% 
  .$PLOT %>% n_distinct
  
